<!DOCTYPE html>
<html lang="bn">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=yes">
    <title>‡¶≠‡ßã‡¶ü‡¶æ‡¶∞ ‡¶°‡¶æ‡¶ü‡¶æ‡¶¨‡ßá‡¶ú ¬∑ ‡¶ú‡¶æ‡¶Æ‡¶æ‡¶Ø‡¶º‡¶æ‡¶§‡ßá ‡¶á‡¶∏‡¶≤‡¶æ‡¶Æ‡ßÄ</title>
    <!-- Google Fonts & professional icon set -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Hind+Siliguri:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
            font-family: 'Hind Siliguri', sans-serif;
        }

        :root {
            --primary: #006a4e;
            --primary-dark: #004d39;
            --primary-soft: #e8f3ef;
            --accent-8: #0b7b69;
            --accent-9: #2563eb;
            --bg-light: #f4f9f7;
            --card-white: #ffffff;
            --text-dark: #1e293b;
            --text-soft: #475569;
            --border-light: #dee7e2;
            --shadow-card: 0 8px 20px rgba(0, 40, 30, 0.08);
            --gold-light: #fef9e7;
        }

        body {
            background-color: var(--bg-light);
            color: var(--text-dark);
            min-height: 100vh;
            padding-bottom: 20px;
        }

        /* ‡¶≤‡ßã‡¶°‡¶æ‡¶∞ */
        #loader {
            position: fixed; inset: 0; background: #0f2c22; z-index: 9999;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            transition: opacity 0.3s ease; color: white;
        }
        .loader-spinner {
            width: 56px; height: 56px; border: 5px solid rgba(255,255,255,0.1); border-top: 5px solid white; border-radius: 50%;
            animation: spin 0.9s cubic-bezier(0.6,0.2,0.4,0.8) infinite; margin-bottom: 16px;
        }
        #loader p { font-size: 1.1rem; letter-spacing: 0.5px; opacity: 0.9; }

        /* ‡¶π‡ßá‡¶°‡¶æ‡¶∞ ‚Äì ‡¶´‡¶ø‡¶ï‡ßç‡¶∏‡¶° */
        .fixed-header {
            position: fixed; top: 0; left: 0; right: 0; z-index: 100;
            background: var(--primary-dark);
            color: white;
            padding: 12px 16px 8px;
            box-shadow: 0 4px 12px rgba(0,40,30,0.25);
        }

        .header-top {
            display: flex; align-items: center; justify-content: space-between;
            max-width: 1200px; margin: 0 auto;
        }

        .brand h1 {
            font-size: 1.1rem; font-weight: 600; line-height: 1.3;
            display: flex; align-items: center; gap: 6px;
        }
        .brand i { font-size: 1.2rem; color: #ffd966; }

        .header-actions {
            display: flex; gap: 8px; align-items: center;
        }

        .icon-btn {
            background: rgba(255,255,255,0.15);
            border: none; border-radius: 40px;
            width: 42px; height: 42px;
            display: flex; align-items: center; justify-content: center;
            color: white; font-size: 1.2rem;
            cursor: pointer;
            transition: 0.2s;
        }
        .icon-btn:hover { background: rgba(255,255,255,0.3); }
        .total-badge {
            background: white; color: var(--primary-dark); font-weight: 700;
            padding: 8px 16px; border-radius: 40px; font-size: 1rem;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        /* ‡¶´‡¶ø‡¶≤‡ßç‡¶ü‡¶æ‡¶∞ ‡¶∏‡ßá‡¶ï‡¶∂‡¶® */
        .filter-section {
            max-width: 1200px; margin: 12px auto 0;
            display: flex; flex-direction: column; gap: 8px;
        }
        .search-card {
            background: white; border-radius: 60px; padding: 4px 4px 4px 16px;
            display: flex; align-items: center; gap: 6px;
            border: 1px solid #ccdfd8;
            box-shadow: 0 2px 6px rgba(0,60,40,0.05);
        }
        .search-card i {
            color: var(--primary); font-size: 1rem;
        }
        .search-card select {
            border: none; background: #f0f7f3; padding: 8px 12px;
            border-radius: 40px; font-size: 0.85rem; font-weight: 500;
            color: var(--primary-dark); outline: none;
            cursor: pointer;
        }
        .search-card input {
            border: none; flex: 1; padding: 10px 0; font-size: 0.95rem;
            background: transparent; outline: none; color: var(--text-dark);
        }

        /* ‡¶¨‡ßü‡¶∏ ‡¶´‡¶ø‡¶≤‡ßç‡¶ü‡¶æ‡¶∞ */
        .age-filter-card {
            background: white; border-radius: 40px; padding: 4px 12px 4px 18px;
            display: flex; align-items: center; gap: 10px;
            border: 1px solid #ccdfd8;
        }
        .age-filter-card i {
            color: var(--primary); font-size: 1rem;
        }
        .age-filter-card select {
            width: 100%; border: none; background: transparent; padding: 12px 0;
            font-size: 0.95rem; font-weight: 400; color: var(--text-dark);
            outline: none; cursor: pointer;
        }

        /* ‡¶ü‡ßç‡¶Ø‡¶æ‡¶¨ */
        .tabs-grid {
            max-width: 1200px; margin: 16px auto 0;
            display: grid; grid-template-columns: repeat(5, 1fr);
            gap: 6px;
        }
        .tab-item {
            background: rgba(255,255,255,0.2);
            border: 1px solid rgba(255,255,255,0.25);
            color: white; padding: 8px 0; border-radius: 40px;
            font-size: 0.8rem; font-weight: 600; text-align: center;
            cursor: pointer; transition: 0.2s;
            white-space: nowrap;
        }
        .tab-item i { margin-right: 4px; font-size: 0.7rem; }
        .tab-item.active {
            background: white; color: var(--primary-dark);
            border-color: white; font-weight: 700;
        }

        /* ‡¶Æ‡ßÇ‡¶≤ ‡¶ï‡¶®‡ßç‡¶ü‡ßá‡¶®‡ßç‡¶ü */
        .content-wrapper {
            max-width: 1200px; margin: 0 auto;
            padding: 240px 12px 40px;
        }
        @media (max-width: 500px) {
            .content-wrapper { padding-top: 260px; }
        }

        /* ‡¶≠‡ßã‡¶ü‡¶æ‡¶∞ ‡¶ó‡ßç‡¶∞‡¶ø‡¶° */
        .voter-grid {
            display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 18px;
        }

        .voter-card {
            background: var(--card-white);
            border-radius: 24px;
            box-shadow: var(--shadow-card);
            border: 1px solid var(--border-light);
            transition: 0.2s;
            position: relative;
        }
        
        .voter-card.word-8 { border-left: 6px solid var(--accent-8); }
        .voter-card.word-9 { border-left: 6px solid var(--accent-9); }

        .voter-card::before {
            content: attr(data-watermark);
            position: absolute; bottom: 8px; right: 12px;
            font-size: 6rem; font-weight: 800;
            color: rgba(0,80,60,0.02);
            z-index: 0;
            pointer-events: none;
        }

        .card-header {
            display: flex; justify-content: space-between; align-items: center;
            padding: 12px 16px 4px;
        }
        .serial-pill {
            background: var(--primary-soft);
            color: var(--primary-dark);
            font-weight: 700; font-size: 0.8rem;
            padding: 4px 14px; border-radius: 30px;
            display: inline-flex; align-items: center; gap: 4px;
        }
        .id-badge {
            background: #f1f8f4;
            padding: 4px 12px; border-radius: 30px;
            font-size: 0.7rem; font-weight: 600; color: #2f5e4a;
        }

        .card-body {
            padding: 8px 16px 12px;
            position: relative; z-index: 2;
        }

        .voter-name {
            font-size: 1.4rem; font-weight: 700; line-height: 1.3;
            margin-bottom: 8px; color: #0b3b2e;
            word-break: break-word;
        }

        .info-line {
            display: flex; align-items: baseline; gap: 10px;
            font-size: 0.9rem; margin-bottom: 6px;
            color: var(--text-soft);
        }
        .info-line i {
            width: 20px; color: var(--primary); font-size: 0.85rem;
        }

        .age-banner {
            background: var(--gold-light);
            border: 1px solid #f7e5b5;
            border-radius: 40px;
            padding: 8px 14px; margin: 10px 0 8px;
            display: flex; align-items: center; gap: 10px;
            font-size: 0.9rem; font-weight: 600; color: #8d6300;
        }

        .card-footer {
            display: flex; justify-content: space-between;
            border-top: 1px dashed #cee2d8;
            padding-top: 10px; margin-top: 4px;
            font-size: 0.8rem; color: #417561;
        }
        .address-chip {
            background: #ecf6f2; padding: 4px 12px; border-radius: 30px;
            font-weight: 500; display: inline-flex; align-items: center; gap: 4px;
        }

        /* ‡¶ü‡ßã‡¶∏‡ßç‡¶ü */
        #toast {
            position: fixed; bottom: 24px; left: 50%; transform: translateX(-50%);
            background: #1e3d35; color: #f3ffe0; padding: 12px 28px;
            border-radius: 60px; font-size: 0.9rem; font-weight: 500;
            box-shadow: 0 12px 24px rgba(0,30,20,0.3); z-index: 9999;
            opacity: 0; transition: opacity 0.25s;
            border: 1px solid #467a66;
        }

        .empty-state {
            grid-column: 1/-1; text-align: center; padding: 60px 20px;
            background: white; border-radius: 48px; color: #6a8b7e;
            font-size: 1.2rem; border: 2px dashed #c2ddd2;
        }

        @keyframes spin { to { transform: rotate(360deg); } }
    </style>
</head>
<body>

<div id="loader">
    <div class="loader-spinner"></div>
    <p>‡¶≠‡ßã‡¶ü‡¶æ‡¶∞ ‡¶§‡¶•‡ßç‡¶Ø ‡¶Ü‡¶®‡¶õ‡ßá ...</p>
</div>

<header class="fixed-header">
    <div class="header-top">
        <div class="brand">
            <i class="fas fa-mosque"></i>
            <h1>‡¶ú‡¶æ‡¶Æ‡¶æ‡¶Ø‡¶º‡¶æ‡¶§‡ßá ‡¶á‡¶∏‡¶≤‡¶æ‡¶Æ‡ßÄ ¬∑ ‡¶≠‡ßã‡¶ü‡¶æ‡¶∞</h1>
        </div>
        <div class="header-actions">
            <button class="icon-btn" onclick="downloadExcel()" title="‡¶è‡¶ï‡ßç‡¶∏‡ßá‡¶≤ ‡¶°‡¶æ‡¶â‡¶®‡¶≤‡ßã‡¶°"><i class="fas fa-download"></i></button>
            <button class="icon-btn" onclick="manualSync()" title="‡¶∏‡¶ø‡¶ô‡ßç‡¶ï/‡¶∞‡¶ø‡¶´‡ßç‡¶∞‡ßá‡¶∂"><i class="fas fa-sync-alt" id="syncIcon"></i></button>
            <span class="total-badge" id="totalCount">‡ß¶</span>
        </div>
    </div>

    <div class="filter-section">
        <div class="search-card">
            <i class="fas fa-sliders-h"></i>
            <select id="searchFilter">
                <option value="all">‡¶∏‡¶¨ ‡¶§‡¶•‡ßç‡¶Ø</option>
                <option value="Name">‡¶®‡¶æ‡¶Æ</option>
                <option value="Father_Name">‡¶™‡¶ø‡¶§‡¶æ</option>
                <option value="Voter_No">‡¶≠‡ßã‡¶ü‡¶æ‡¶∞ ‡¶®‡¶Ç</option>
            </select>
            <input type="text" id="searchInput" placeholder="‡¶®‡¶æ‡¶Æ/‡¶™‡¶ø‡¶§‡¶æ/‡¶≠‡ßã‡¶ü‡¶æ‡¶∞ ‡¶®‡¶Ç" autocomplete="off">
        </div>

        <div class="age-filter-card">
            <i class="fas fa-calendar-alt"></i>
            <select id="ageRangeFilter">
                <option value="all">‡¶∏‡¶¨ ‡¶¨‡ßü‡¶∏‡ßÄ</option>
                <option value="65up">‡ß¨‡ß´ ‡¶¨‡¶õ‡¶∞ ‡¶ì ‡¶§‡¶¶‡ßÇ‡¶∞‡ßç‡¶ß‡ßç‡¶¨</option>
                <option value="64">‡ß¨‡ß™ ‡¶¨‡¶õ‡¶∞ (‡ß¨‡ß´ ‡¶π‡ßü‡¶®‡¶ø)</option>
                <option value="63">‡ß¨‡ß© ‡¶¨‡¶õ‡¶∞ (‡ß¨‡ß™ ‡¶π‡ßü‡¶®‡¶ø)</option>
                <option value="62">‡ß¨‡ß® ‡¶¨‡¶õ‡¶∞ (‡ß¨‡ß© ‡¶π‡ßü‡¶®‡¶ø)</option>
                <option value="61">‡ß¨‡ßß ‡¶¨‡¶õ‡¶∞ (‡ß¨‡ß® ‡¶π‡ßü‡¶®‡¶ø)</option>
            </select>
        </div>
    </div>

    <div class="tabs-grid" id="tabList">
        <div class="tab-item active" data-source="all"><i class="fas fa-layer-group"></i> ‡¶∏‡¶¨</div>
        <div class="tab-item" data-source="8p"><i class="fas fa-male"></i> ‡ßÆ ‡¶™‡ßÅ‡¶∞‡ßÅ‡¶∑</div>
        <div class="tab-item" data-source="8m"><i class="fas fa-female"></i> ‡ßÆ ‡¶Æ‡¶π‡¶ø‡¶≤‡¶æ</div>
        <div class="tab-item" data-source="9p"><i class="fas fa-male"></i> ‡ßØ ‡¶™‡ßÅ‡¶∞‡ßÅ‡¶∑</div>
        <div class="tab-item" data-source="9m"><i class="fas fa-female"></i> ‡ßØ ‡¶Æ‡¶π‡¶ø‡¶≤‡¶æ</div>
    </div>
</header>

<main class="content-wrapper">
    <div id="voterContainer" class="voter-grid"></div>
</main>

<div id="toast"></div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
<script>
    (function() {
        // ‡¶ï‡¶®‡¶´‡¶ø‡¶ó‡¶æ‡¶∞‡ßá‡¶∂‡¶®
        const baseUrl = 'https://raw.githubusercontent.com/sd-rubel/sd-election/main/';
        const files = { '8p': '8p.csv', '8m': '8m.csv', '9p': '9p.csv', '9m': '9m.csv' };
        
        // ‡¶°‡¶æ‡¶ü‡¶æ ‡¶∏‡ßç‡¶ü‡ßã‡¶∞
        let masterData = { '8p': [], '8m': [], '9p': [], '9m': [] };
        let activeTab = 'all';
        let filteredFullList = [];
        let allVoters = []; // ‡¶∏‡¶¨ ‡¶≠‡ßã‡¶ü‡¶æ‡¶∞ ‡¶è‡¶ï‡¶∏‡¶æ‡¶•‡ßá
        
        // ‡¶Ü‡¶ú‡¶ï‡ßá‡¶∞ ‡¶§‡¶æ‡¶∞‡¶ø‡¶ñ (‡ß®‡ßß ‡¶´‡ßá‡¶¨‡ßç‡¶∞‡ßÅ‡¶Ø‡¶º‡¶æ‡¶∞‡¶ø ‡ß®‡ß¶‡ß®‡ß¨)
        const TODAY = new Date(2026, 1, 21);

        // ‡¶´‡¶æ‡¶Ç‡¶∂‡¶®: ‡¶≤‡ßã‡¶°‡¶æ‡¶∞ ‡¶≤‡ßÅ‡¶ï‡¶æ‡¶ì
        function hideLoader() {
            const loader = document.getElementById('loader');
            loader.style.opacity = '0';
            setTimeout(() => loader.style.display = 'none', 400);
        }

        // ‡¶´‡¶æ‡¶Ç‡¶∂‡¶®: ‡¶°‡¶ø‡¶ì‡¶¨‡¶ø ‡¶™‡¶æ‡¶∞‡ßç‡¶∏
        function parseDOB(dobStr) {
            if (!dobStr) return null;
            // ‡¶Ø‡ßá‡¶ï‡ßã‡¶®‡ßã ‡¶´‡¶∞‡¶Æ‡ßç‡¶Ø‡¶æ‡¶ü: dd/mm/yyyy, dd-mm-yyyy, dd.mm.yyyy
            const match = dobStr.toString().match(/(\d{1,2})[\/\-\.](\d{1,2})[\/\-\.](\d{2,4})/);
            if (!match) return null;
            
            let d = parseInt(match[1]);
            let m = parseInt(match[2]) - 1;
            let y = parseInt(match[3]);
            
            // ‡ß® ‡¶°‡¶ø‡¶ú‡¶ø‡¶ü‡ßá‡¶∞ ‡¶¨‡¶õ‡¶∞ ‡¶†‡¶ø‡¶ï ‡¶ï‡¶∞‡¶æ
            if (y < 100) {
                y = y > 30 ? 1900 + y : 2000 + y; // 30 ‡¶è‡¶∞ ‡¶¨‡ßá‡¶∂‡¶ø ‡¶π‡¶≤‡ßá 1900, ‡¶®‡¶æ ‡¶π‡¶≤‡ßá 2000
            }
            
            const date = new Date(y, m, d);
            return isNaN(date) ? null : date;
        }

        // ‡¶´‡¶æ‡¶Ç‡¶∂‡¶®: ‡¶¨‡¶ø‡¶∏‡ßç‡¶§‡¶æ‡¶∞‡¶ø‡¶§ ‡¶¨‡ßü‡¶∏
        function getDetailedAge(dobStr) {
            const bdate = parseDOB(dobStr);
            if (!bdate) return null;
            
            let years = TODAY.getFullYear() - bdate.getFullYear();
            let months = TODAY.getMonth() - bdate.getMonth();
            let days = TODAY.getDate() - bdate.getDate();
            
            if (days < 0) {
                months--;
                let lastMonth = new Date(TODAY.getFullYear(), TODAY.getMonth(), 0);
                days += lastMonth.getDate();
            }
            if (months < 0) {
                years--;
                months += 12;
            }
            
            return { years, months, days, text: `${years} ‡¶¨‡¶õ‡¶∞, ${months} ‡¶Æ‡¶æ‡¶∏, ${days} ‡¶¶‡¶ø‡¶®` };
        }

        // ‡¶´‡¶æ‡¶Ç‡¶∂‡¶®: ‡¶∏‡¶¨ ‡¶≠‡ßã‡¶ü‡¶æ‡¶∞‡ßá‡¶∞ ‡¶¨‡ßü‡¶∏ ‡¶ï‡ßç‡¶Ø‡¶æ‡¶≤‡¶ï‡ßÅ‡¶≤‡ßá‡¶ü
        function recalcAllAges() {
            Object.keys(masterData).forEach(key => {
                masterData[key] = masterData[key].map(v => ({
                    ...v,
                    ageDetails: getDetailedAge(v.DOB)
                }));
            });
            
            // ‡¶Ö‡¶≤ ‡¶≠‡ßã‡¶ü‡¶æ‡¶∞ ‡¶Ü‡¶™‡¶°‡ßá‡¶ü
            allVoters = [
                ...masterData['8p'].map(v => ({...v, word: '8'})),
                ...masterData['8m'].map(v => ({...v, word: '8'})),
                ...masterData['9p'].map(v => ({...v, word: '9'})),
                ...masterData['9m'].map(v => ({...v, word: '9'}))
            ];
        }

        // ‡¶´‡¶æ‡¶Ç‡¶∂‡¶®: ‡¶´‡¶ø‡¶≤‡ßç‡¶ü‡¶æ‡¶∞ ‡¶ì ‡¶∞‡ßá‡¶®‡ßç‡¶°‡¶æ‡¶∞
        function renderData() {
            const search = document.getElementById('searchInput').value.trim().toLowerCase();
            const filterType = document.getElementById('searchFilter').value;
            const ageRange = document.getElementById('ageRangeFilter').value;

            // ‡¶∏‡ßã‡¶∞‡ßç‡¶∏ ‡¶®‡¶ø‡¶∞‡ßç‡¶ß‡¶æ‡¶∞‡¶£ (‡¶Ö‡¶≤ ‡¶¨‡¶æ ‡¶®‡¶ø‡¶∞‡ßç‡¶¶‡¶ø‡¶∑‡ßç‡¶ü ‡¶ü‡ßç‡¶Ø‡¶æ‡¶¨)
            let source;
            if (activeTab === 'all') {
                source = allVoters;
            } else {
                source = masterData[activeTab] || [];
            }

            // ‡¶´‡¶ø‡¶≤‡ßç‡¶ü‡¶æ‡¶∞ ‡¶™‡ßç‡¶∞‡ßü‡ßã‡¶ó
            filteredFullList = source.filter(v => {
                // ‡¶¨‡ßü‡¶∏ ‡¶´‡¶ø‡¶≤‡ßç‡¶ü‡¶æ‡¶∞
                if (ageRange !== 'all') {
                    if (!v.ageDetails) return false;
                    const y = v.ageDetails.years;
                    if (ageRange === '65up' && y < 65) return false;
                    else if (ageRange !== '65up' && y != parseInt(ageRange)) return false;
                }
                
                // ‡¶∏‡¶æ‡¶∞‡ßç‡¶ö ‡¶´‡¶ø‡¶≤‡ßç‡¶ü‡¶æ‡¶∞
                if (search) {
                    let fieldValue;
                    if (filterType === 'all') {
                        fieldValue = `${v.Name || ''} ${v.Father_Name || ''} ${v.Voter_No || ''}`.toLowerCase();
                    } else {
                        fieldValue = (v[filterType] || '').toLowerCase();
                    }
                    return fieldValue.includes(search);
                }
                
                return true;
            });

            // ‡¶ï‡¶æ‡¶â‡¶®‡ßç‡¶ü ‡¶Ü‡¶™‡¶°‡ßá‡¶ü
            document.getElementById('totalCount').innerText = filteredFullList.length.toLocaleString('bn-IN');

            // ‡¶™‡ßç‡¶∞‡¶•‡¶Æ ‡ßß‡ß´‡ß¶ ‡¶ü‡¶ø ‡¶¶‡ßá‡¶ñ‡¶æ‡¶á (‡¶™‡¶æ‡¶∞‡¶´‡¶∞‡¶Æ‡ßç‡¶Ø‡¶æ‡¶®‡ßç‡¶∏)
            const displayList = filteredFullList.slice(0, 150);

            if (displayList.length === 0) {
                document.getElementById('voterContainer').innerHTML = '<div class="empty-state"><i class="fas fa-database"></i><br/>‡¶ï‡ßã‡¶®‡ßã ‡¶≠‡ßã‡¶ü‡¶æ‡¶∞ ‡¶§‡¶•‡ßç‡¶Ø ‡¶®‡ßá‡¶á</div>';
                return;
            }

            // ‡¶è‡¶á‡¶ö‡¶ü‡¶ø‡¶è‡¶Æ‡¶è‡¶≤ ‡¶§‡ßà‡¶∞‡¶ø
            let html = '';
            displayList.forEach(v => {
                const wordClass = v.word === '9' ? 'word-9' : 'word-8';
                const watermark = v.word === '9' ? '‡ßØ' : '‡ßÆ';
                
                html += `
                <div class="voter-card ${wordClass}" data-watermark="${watermark}">
                    <div class="card-header">
                        <span class="serial-pill"><i class="fas fa-hashtag"></i> ${v.Serial || ''}</span>
                        <span class="id-badge"><i class="far fa-id-card"></i> ${v.Voter_No || ''}</span>
                    </div>
                    <div class="card-body">
                        <div class="voter-name">${v.Name || ''}</div>
                        <div class="info-line"><i class="fas fa-user-tie"></i> <strong>‡¶™‡¶ø‡¶§‡¶æ:</strong> ${v.Father_Name || ''}</div>
                        <div class="info-line"><i class="fas fa-user"></i> <strong>‡¶Æ‡¶æ‡¶§‡¶æ:</strong> ${v.Mother_Name || '‚Äî'}</div>
                        <div class="age-banner"><i class="fas fa-hourglass-half"></i> ${v.ageDetails ? v.ageDetails.text : '‡¶¨‡ßü‡¶∏ ‡¶ó‡¶£‡¶®‡¶æ ‡¶π‡ßü‡¶®‡¶ø'}</div>
                        <div class="card-footer">
                            <span><i class="far fa-calendar-alt"></i> ${v.DOB || ''}</span>
                            <span class="address-chip"><i class="fas fa-map-pin"></i> ${(v.Address || '').substring(0,18)}${(v.Address || '').length > 18 ? '‚Ä¶' : ''}</span>
                        </div>
                    </div>
                </div>`;
            });
            
            document.getElementById('voterContainer').innerHTML = html;
        }

        // ‡¶´‡¶æ‡¶Ç‡¶∂‡¶®: ‡¶∏‡¶ø‡¶ô‡ßç‡¶ï (‡¶°‡¶æ‡¶ü‡¶æ ‡¶≤‡ßã‡¶°)
        window.manualSync = async function() {
            const icon = document.getElementById('syncIcon');
            if (icon) icon.style.animation = 'spin 0.8s linear infinite';
            
            showToast('‡¶°‡¶æ‡¶ü‡¶æ ‡¶≤‡ßã‡¶° ‡¶π‡¶ö‡ßç‡¶õ‡ßá...');
            
            try {
                // ‡¶∏‡¶¨ ‡¶´‡¶æ‡¶á‡¶≤ ‡¶è‡¶ï‡¶∏‡¶æ‡¶•‡ßá ‡¶≤‡ßã‡¶°
                const results = await Promise.all(
                    Object.entries(files).map(([key, file]) => 
                        new Promise((resolve) => {
                            Papa.parse(baseUrl + file + '?t=' + Date.now(), {
                                download: true,
                                header: true,
                                skipEmptyLines: true,
                                complete: (results) => {
                                    const data = results.data.filter(row => row.Name && row.Name.trim() !== '');
                                    resolve({ key, data });
                                },
                                error: (error) => {
                                    console.error(`${file} ‡¶≤‡ßã‡¶° ‡¶ï‡¶∞‡¶§‡ßá ‡¶∏‡¶Æ‡¶∏‡ßç‡¶Ø‡¶æ:`, error);
                                    resolve({ key, data: [] }); // ‡¶è‡¶∞‡¶∞ ‡¶π‡¶≤‡ßá‡¶ì ‡¶ñ‡¶æ‡¶≤‡¶ø ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶∞‡ßá
                                }
                            });
                        })
                    )
                );
                
                // ‡¶°‡¶æ‡¶ü‡¶æ ‡¶∏‡¶Ç‡¶∞‡¶ï‡ßç‡¶∑‡¶£
                results.forEach(r => {
                    masterData[r.key] = r.data;
                });
                
                // ‡¶¨‡ßü‡¶∏ ‡¶ï‡ßç‡¶Ø‡¶æ‡¶≤‡¶ï‡ßÅ‡¶≤‡ßá‡¶ü
                recalcAllAges();
                
                // ‡¶≤‡ßã‡¶ï‡¶æ‡¶≤ ‡¶∏‡ßç‡¶ü‡ßã‡¶∞‡ßá‡¶ú‡ßá ‡¶∏‡¶Ç‡¶∞‡¶ï‡ßç‡¶∑‡¶£
                localStorage.setItem('voterDB', JSON.stringify(masterData));
                
                // ‡¶∞‡ßá‡¶®‡ßç‡¶°‡¶æ‡¶∞
                renderData();
                
                // ‡¶ü‡ßã‡¶ü‡¶æ‡¶≤ ‡¶ï‡¶æ‡¶â‡¶®‡ßç‡¶ü ‡¶¶‡ßá‡¶ñ‡¶æ‡¶®
                const total = allVoters.length;
                showToast(`‚úÖ ${total} ‡¶ü‡¶ø ‡¶≠‡ßã‡¶ü‡¶æ‡¶∞ ‡¶≤‡ßã‡¶° ‡¶π‡ßü‡ßá‡¶õ‡ßá`);
                
            } catch (error) {
                console.error('‡¶∏‡¶ø‡¶ô‡ßç‡¶ï ‡¶è‡¶∞‡¶∞:', error);
                showToast('‚ùå ‡¶∏‡¶æ‡¶∞‡ßç‡¶≠‡¶æ‡¶∞ ‡¶∏‡¶Ç‡¶Ø‡ßã‡¶ó ‡¶¨‡ßç‡¶Ø‡¶∞‡ßç‡¶•');
                
                // ‡¶ï‡ßç‡¶Ø‡¶æ‡¶∂ ‡¶•‡¶æ‡¶ï‡¶≤‡ßá ‡¶∏‡ßá‡¶ü‡¶æ ‡¶¶‡ßá‡¶ñ‡¶æ‡¶®
                if (allVoters.length > 0) {
                    renderData();
                }
            } finally {
                if (icon) icon.style.animation = '';
                hideLoader();
            }
        };

        // ‡¶´‡¶æ‡¶Ç‡¶∂‡¶®: ‡¶°‡¶æ‡¶â‡¶®‡¶≤‡ßã‡¶°
        window.downloadExcel = function() {
            if (filteredFullList.length === 0) {
                showToast('üì≠ ‡¶ï‡ßã‡¶®‡ßã ‡¶§‡¶•‡ßç‡¶Ø ‡¶®‡ßá‡¶á');
                return;
            }
            
            const exportData = filteredFullList.map(v => ({
                '‡¶ï‡ßç‡¶∞‡¶Æ‡¶ø‡¶ï': v.Serial,
                '‡¶®‡¶æ‡¶Æ': v.Name,
                '‡¶™‡¶ø‡¶§‡¶æ‡¶∞ ‡¶®‡¶æ‡¶Æ': v.Father_Name,
                '‡¶Æ‡¶æ‡¶§‡¶æ‡¶∞ ‡¶®‡¶æ‡¶Æ': v.Mother_Name || '',
                '‡¶≠‡ßã‡¶ü‡¶æ‡¶∞ ‡¶®‡¶Ç': v.Voter_No,
                '‡¶ú‡¶®‡ßç‡¶Æ ‡¶§‡¶æ‡¶∞‡¶ø‡¶ñ': v.DOB,
                '‡¶¨‡ßü‡¶∏': v.ageDetails ? v.ageDetails.text : '',
                '‡¶†‡¶ø‡¶ï‡¶æ‡¶®‡¶æ': v.Address
            }));
            
            const csv = Papa.unparse(exportData);
            const blob = new Blob(["\uFEFF" + csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `Jamaat_Voter_List_${new Date().toISOString().slice(0,10)}.csv`;
            link.click();
            showToast('‚¨áÔ∏è ‡¶°‡¶æ‡¶â‡¶®‡¶≤‡ßã‡¶° ‡¶∂‡ßÅ‡¶∞‡ßÅ');
        };

        // ‡¶´‡¶æ‡¶Ç‡¶∂‡¶®: ‡¶ü‡ßã‡¶∏‡ßç‡¶ü
        window.showToast = function(msg) {
            const toast = document.getElementById('toast');
            toast.textContent = msg;
            toast.style.opacity = '1';
            setTimeout(() => toast.style.opacity = '0', 2000);
        };

        // ‡¶á‡¶≠‡ßá‡¶®‡ßç‡¶ü ‡¶∏‡ßá‡¶ü‡¶Ü‡¶™
        function setupEvents() {
            document.getElementById('searchInput').addEventListener('input', renderData);
            document.getElementById('ageRangeFilter').addEventListener('change', renderData);
            document.getElementById('searchFilter').addEventListener('change', renderData);
            
            document.getElementById('tabList').addEventListener('click', (e) => {
                const tab = e.target.closest('.tab-item');
                if (!tab) return;
                
                document.querySelectorAll('.tab-item').forEach(t => t.classList.remove('active'));
                tab.classList.add('active');
                activeTab = tab.dataset.source;
                renderData();
            });
        }

        // ‡¶™‡ßÉ‡¶∑‡ßç‡¶†‡¶æ ‡¶≤‡ßã‡¶° ‡¶π‡¶≤‡ßá
        window.onload = async () => {
            // ‡¶≤‡ßã‡¶ï‡¶æ‡¶≤ ‡¶ï‡ßç‡¶Ø‡¶æ‡¶∂ ‡¶ö‡ßá‡¶ï
            const cached = localStorage.getItem('voterDB');
            
            if (cached) {
                try {
                    masterData = JSON.parse(cached);
                    recalcAllAges();
                    renderData();
                    hideLoader();
                    
                    // ‡¶¨‡ßç‡¶Ø‡¶æ‡¶ï‡¶ó‡ßç‡¶∞‡¶æ‡¶â‡¶®‡ßç‡¶°‡ßá ‡¶Ü‡¶™‡¶°‡ßá‡¶ü ‡¶ö‡ßá‡¶ï
                    setTimeout(() => manualSync(), 1000);
                    
                } catch (e) {
                    console.warn('‡¶ï‡ßç‡¶Ø‡¶æ‡¶∂ ‡¶ï‡¶∞‡¶æ‡¶™‡ßç‡¶ü, ‡¶®‡¶§‡ßÅ‡¶® ‡¶≤‡ßã‡¶° ‡¶π‡¶ö‡ßç‡¶õ‡ßá');
                    await manualSync();
                }
            } else {
                await manualSync();
            }
            
            setupEvents();
        };

        // ‡¶™‡ßÉ‡¶∑‡ßç‡¶†‡¶æ ‡¶≤‡ßã‡¶° ‡¶∂‡ßá‡¶∑‡ßá ‡¶≤‡ßã‡¶°‡¶æ‡¶∞ ‡¶π‡¶æ‡¶á‡¶° ‡¶®‡¶ø‡¶∂‡ßç‡¶ö‡¶ø‡¶§ ‡¶ï‡¶∞‡¶æ
        if (document.readyState === 'complete') {
            setTimeout(hideLoader, 500);
        }
    })();
</script>
</body>
</html>